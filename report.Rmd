---
title: Multiple Linear Regression Analysis of NBA Player Salaries
date: "`r Sys.Date()`"
output:
 bookdown::pdf_document2: default
---

```{r setup, message=FALSE, results="hide", include=FALSE}
knitr::opts_chunk$set(echo = FALSE, eval = TRUE, results="hide", message=FALSE, cache=TRUE)
if(!require("GGally")) install.packages("GGally")
if(!require("kableExtra")) install.packages("kableExtra")
library("knitr")
# if(!require("magick")) install.packages("magick")
library("forcats")
library("bookdown")
library("readr")
library("dplyr")
library("patchwork")
```

\newpage

# Contributions

# Introduction

# Data Description

## Data Source

The dataset analyzed here was constructed by Davide Ratto, combining statistics from several public sources available through a project undertaken at a Milan-based university. Data from websites such as basketball-reference.com, hoopshype.com and a Kaggle repository contributed to this dataset. The objective of the initial study was to create forecasts for players’ selection to the All-Star Game using a combination of data on performance and popularity. Only the most recent season’s data was kept for each player to preserve a sample that operators of the datasets consider independent.

## Variables

We're analyzing the players' Salary (response variable) with these predictors:

- Points Per Game (PTS): Measures a player's scoring ability and offensive productivity.
- Personal Fouls Per Game (PF): Reflective of a player’s defensive discipline and quality.
- Assists Per Game (AST): Reflects offensive role and playmaking contributions.
- Steals Per Game (STL): Indicator of defensive activity and quality.
- Main Position (Pos1: [PG, SG, SF, PF, C]): A categorical variable that reflects role on court, adding context to the above continuous predictors.

```{r clean}
nba_final <- read.csv("data/nba_final.csv")
nba_final <- nba_final |>
  filter(Salary>3e5)
write.csv(nba_final, file = "data/nba_final_cleaned.csv")
```

We have filtering out players with missing salary information or wages close to minimum wage for an NBA player, since these are essentially fixed points not affected by any predictors.

## Variable Summaries

```{r scatter-matrix, fig.cap="Scatterplot matrix of respoonse and continuous predictors"}
nba_final <- nba_final |>
  mutate(Salary = Salary / 1e6) # change unit to salary in millions
ggpairs(nba_final,
        columns = c("PTS", "PF", "AST", "STL", "Salary"))
```

Final row of Figure \@ref(fig:scatter-matrix) shows that the response variable (Salary) is roughly linear in the other 4 predictor variables. This indicates that linear regression is suitable here. Figure \@ref(fig:box-plots) shows that the box plots of Salary against each dummy categorical variable (i.e. level) has different Q2, Q3, and IQR values, except for point forward (PF) and shooting guard (SG). This indicates that player position (Pos1) will be a good categorical predictor for Salary after we group PF and SG as one single level.

```{r box-plots, fig.cap="Box Plots of Salary against categorical dummy variables"}
ggplot(nba_final) +
  geom_boxplot(aes(x = Salary, y = Pos1)) +
  labs(x = "Salary (Millions)", y = "Player Position (Pos1)")
```

# Preliminary Results

## Residual Analysis

```{r lin-model}
nba_final <- nba_final |>
  # change the team name into categorical levels
  mutate(Pos1 = factor(Pos1)) |>
  # group SG and PF into a single level
  mutate(Pos1 = fct_collapse(Pos1, "SG+PF" = c("SG", "PF"))) |>
  # use shooting guard as reference level
  mutate(Pos1 = relevel(Pos1, ref = "SG+PF"))
nba_model <- lm(Salary ~ PTS + PF + AST + STL + Pos1, data=nba_final)
```

```{r diagnostic-1, fig.cap = "Diagnostic Plots"}
summary(nba_model)
graph_summaries_1 <- function(){
  par(mfrow=c(1, 2))
  p1 <- plot(nba_model, which=1)
  p2 <- plot(nba_model, which=2)
}
graph_summaries_1()
```

```{r diagnostic-2, fig.cap = "Diagnostic Plots, continued"}
graph_summaries_2 <- function(){
  p3 <- ggplot(nba_model) +
    geom_point(aes(x = .fitted, y = nba_final$Salary)) +
    labs(x = "Fitted Values") +
    labs(y = "Response \n Salary") +
    geom_abline(color = "blue") +
    labs(title = "Response vs. Fitted") +
    theme(plot.title = element_text(hjust = 0.5))
  p4 <- ggplot(nba_model) +
    geom_histogram(aes(x = rstandard(nba_model)), bins = 20) +
    theme(plot.title = element_text(hjust = 0.5)) +
    labs(title = "Standarized Residuals Histogram") +
    labs(x = "Standardized Residuals") +
    labs(y = "Count")
  p3 + p4
}
graph_summaries_2()
```

We notice a few signs that our model violates linear regression assumptions. The residual vs. fitted graph (Figure \@ref(fig:diagnostic-1), left) has points with uneven spread, which indicates heteroscedasticity (i.e. non-constant variance of the error term in the model). From the same graph, since the expected value of the residuals is not 0 across the range, non-linearity of our model is also apparent, i.e. Equation \@ref(eq:fitted-model) does not hold.
\begin{equation}
\hat{E}\left[\textbf{Y} \vert \textbf{X}\right] = \widehat{Salary} = \hat{\beta_0} + \hat{\beta_1}PTS + \hat{\beta_2}\ PF + \hat{\beta_3}\ AST + \hat{\beta_4}\ STL + \hat{\beta_5}\ I(C)+ \hat{\beta_6}\ I(PG)+ \hat{\beta_7}\ I(SF)
(\#eq:fitted-model)
\end{equation}

The model also violates the *normality of error* assumption. The normal-QQ plot (Figure \@ref(fig:diagnostic-1), right) contains points above the identity line from +1 standard deviation and above. The standardized residuals histogram (Figure \@ref(fig:diagnostic-2), right) also shows a long right-tail (right-skewed). This means our model tends to underestimate player salaries at higher salary ranges.

The scatter plot of response vs. fitted values (Figure \@ref(fig:diagnostic-2), left) also suggest heteroscedastic residuals from the wide spread of points around the identity line.

## Model Discussion

```{r prelim-model, fig.cap = "Prelimiary estimation of model parameters", results='markup'}

apd <- sprintf("$\\\\hat{\\\\beta_%d}$", seq(from = 0, to = 7))
est_table <- bind_rows(coef(nba_model))
kable(est_table, format = "latex", booktabs = TRUE, escape = FALSE, caption = "Prelimiary estimation of model parameters.") |>
  kable_styling(latex_options = "hold_position") |>
  add_header_above(apd, escape = FALSE)
```

Because of the violations mentioned above, the interpretations we can make are limited. With that in mind, we notice from the estimated model parameters (as seen in Table \@ref(tab:prelim-model)) that the predictor, assists (AST), contribute to the average salary by about \$1.1 million ($\hat{\beta{3}} \approx 1.09$) for each unit increase while holding all other predictors constant. Personal fouls (PF) has an opposite effect ($\hat{\beta{2}} \approx 0.90$).

For the categorical variables, we expect the average player salary to increase by about \$2.8 million ($\hat{\beta{5}} \approx 2.83$) if they change position from shooting guard or point forward (the reference level, SG+PF) to Centre (C), holding all other predictors constant. A similar analysis can be obtained for the other position dummy variables by reading their corresponding $\hat{\beta}\text{'s}$.
